@using LegendOfRico.Data
@using BootstrapBlazor

<div class="layoutGame" @onkeydown="HandleKeyDown" @onkeydown:preventDefault=true tabindex="0">
    <div class="displayGame">
        <GameMenu Game="Game" TypeOfShowChange="TypeOfShowChange" />
        <div class="mapDisplay">
            <table border="1" class="Map">
                @for (int i = Game.GameMap.StartI; i < Game.GameMap.MaxI; i++)
                {
                    <tr>
                        @for (int j = Game.GameMap.StartJ; j < Game.GameMap.MaxJ; j++)
                        {
                            @if (i == Game.Player.PositionI && j == Game.Player.PositionJ)
                            {
                                <td>
                                    <div style="background-image: url('@Game.GameMap.MapLayout[i][j].SquareBiome.ImageUrl');">
                                        <img src="@Game.Player.MapSprite" alt="Image Player" class="character-image">
                                    </div>
                                </td>
                            }
                            else if (Game.GameMap.MapLayout[i][j].IsACollectDestination)
                            {
                                <td>
                                    <div style="background-image: url('@Game.GameMap.MapLayout[i][j].SquareBiome.ImageUrl');">
                                        <img src="img/Collect/etoile.png" alt="Image Cible" class="character-image">
                                    </div>
                                </td>
                            }
                            else
                            {
                                <td>
                                    <div style="background-image: url('@Game.GameMap.MapLayout[i][j].SquareBiome.ImageUrl');"></div>
                                </td>
                            }

                        }
                    </tr>
                }
            </table>
        </div>
        <div class="mapMenu">
            <p style="display: @(Game.ShowInventory ? "block" : "none")">
                <p>Inventaire consommables:</p>
                @foreach(var item in Game.Player.ConsumableInventory)
                {
                    @if (item.Quantity > 0)
                    {
                        <p>@item.ItemName ( @item.Quantity ) <button @onclick="() => item.Use(Game)">Use</button> </p>
                    }
                }
                <p>Inventaire Stuff:</p>
                @foreach (var item in Game.Player.StuffInventory)
                {
                    <p data-toggle="tooltip" data-placement="top" title="@item.Description">
                        @item.ItemName
                        @if (Game.Player.CanEquip(item))
                        {
                            <button  @onclick="() => Game.Player.EquipStuff(item)">Equiper</button>
                        }
                    </p>
                }
            </p>
            <p style="display: @(Game.ShowQuestList ? "block" : "none")">
                <div class="bossTarget">
                    <p>JoyBean Vaincu: @if (Game.Player.Joydead) {<img src="img/layout/valide.png" /> } else {<img src="img/layout/croix.png" />}</p>
                    <p>Scorpion Vaincu: @if (Game.Player.Scorpiodead) {<img src="img/layout/valide.png" /> } else {<img src="img/layout/croix.png" />}</p>
                    <p>Chef Tontaton Vaincu: @if (Game.Player.Tontatondead) {<img src="img/layout/valide.png" /> } else {<img src="img/layout/croix.png" />}</p>
                    <p>Sun Wukong Vaincu: @if (Game.Player.Wukongdead) {<img src="img/layout/valide.png" /> } else {<img src="img/layout/croix.png" />}</p>
                </div>
                <p class="questTitle">Liste de quêtes:</p>
                @foreach(var quest in Game.Player.QuestsBook)
                {
                <p data-toggle="tooltip" data-placement="top" title="@quest.Description" class="questTaget">
                    @quest.QuestName 
                        @if (quest.Status) {<button @onclick="() => Game.ValidQuest(quest)">Valider</button>}
                    </p>
                }
            </p>
            <p style="display: @(Game.ShowQuestGiver ? "block" : "none")">
            <p>@Game.GameMap.MapLayout[Game.Player.PositionI][Game.Player.PositionJ].MisterQuest.NPCName :</p>
                @if(Game.GameMap.MapLayout[Game.Player.PositionI][Game.Player.PositionJ].MisterQuest.Quests.Count == 0)
                {
                    <p>Je n'ai pas de quêtes à vous proposer</p>
                }
                else
                {
                    foreach (var quest in Game.GameMap.MapLayout[Game.Player.PositionI][Game.Player.PositionJ].MisterQuest.Quests)
                    {
                    <p data-toggle="tooltip" data-placement="top" title="@quest.Description" class="questTaget">
                            @quest.QuestName
                            <button @onclick="() => TakeQuest(quest)">Valider</button>                            
                    </p>
                    }
                }
            </p>
        </div>
    </div>
</div>



@code {

    [Parameter]
    public Game Game { get; set; }
    [Parameter]
    public EventCallback TypeOfShowChange { get; set; }


    void TakeQuest(Quest quest)
    {
        Game.TakeQuest(quest);
        TypeOfShowChange.InvokeAsync();
    }

    //Fonction de gestion des bouton clavier
    private void HandleKeyDown(KeyboardEventArgs e)
    {

        switch (e.Key)
        {
            case "ArrowLeft":
                Game.GoLeft();
                TypeOfShowChange.InvokeAsync();
                break;
            case "ArrowRight":
                Game.GoRight();
                TypeOfShowChange.InvokeAsync();
                break;
            case "ArrowUp":
                Game.GoUp();
                TypeOfShowChange.InvokeAsync();
                break;
            case "ArrowDown":
                Game.GoDown();
                TypeOfShowChange.InvokeAsync();
                break;
        }
        Game.GameMap.UpdateMapDisplay(Game.Player);
    }

}
